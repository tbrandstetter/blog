<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Highly separated Talos Kubernetes Cluster: Part 4 - Talos Cluster installationÂ  - No Rocket Science</title><meta name="description" content="In this part, we install Talos on Proxmox VMs, bootstrap the cluster, enable networking with Calico, and prepare HAProxy Ingress in external mode. Before starting, make sure you already read through the other blog posts of this series: Before we can install the Talos cluster&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part4-mgt-client-installation/"><link rel="alternate" type="application/atom+xml" href="https://norocketscience.at/feed.xml" title="No Rocket Science - RSS"><link rel="alternate" type="application/json" href="https://norocketscience.at/feed.json" title="No Rocket Science - JSON"><meta property="og:title" content="Highly separated Talos Kubernetes Cluster: Part 4 - Talos Cluster installationÂ "><meta property="og:image" content="https://norocketscience.at/media/posts/10/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-2xl.jpg"><meta property="og:image:width" content="1920"><meta property="og:image:height" content="1439"><meta property="og:site_name" content="No Rocket Science"><meta property="og:description" content="In this part, we install Talos on Proxmox VMs, bootstrap the cluster, enable networking with Calico, and prepare HAProxy Ingress in external mode. Before starting, make sure you already read through the other blog posts of this series: Before we can install the Talos cluster&hellip;"><meta property="og:url" content="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part4-mgt-client-installation/"><meta property="og:type" content="article"><link rel="stylesheet" href="https://norocketscience.at/assets/css/style.css?v=c0ed5f91fb502da3c88ca267364ab589"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part4-mgt-client-installation/"},"headline":"Highly separated Talos Kubernetes Cluster: Part 4 - Talos Cluster installationÂ ","datePublished":"2026-03-01T11:07+01:00","dateModified":"2026-03-01T12:01+01:00","image":{"@type":"ImageObject","url":"https://norocketscience.at/media/posts/10/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-2xl.jpg","height":1439,"width":1920},"description":"In this part, we install Talos on Proxmox VMs, bootstrap the cluster, enable networking with Calico, and prepare HAProxy Ingress in external mode. Before starting, make sure you already read through the other blog posts of this series: Before we can install the Talos cluster&hellip;","author":{"@type":"Person","name":"Thomas Brandstetter","url":"https://norocketscience.at/authors/thomas-brandstetter/"},"publisher":{"@type":"Organization","name":"Thomas Brandstetter","logo":{"@type":"ImageObject","url":"https://norocketscience.at/media/website/logo_dark.png","height":211,"width":1379}}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="post-template"><header class="top js-header"><a class="logo" href="https://norocketscience.at/"><img src="https://norocketscience.at/media/website/logo_dark.png" alt="No Rocket Science" width="1379" height="211"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://norocketscience.at/about-2/" title="About" target="_self">About</a></li><li><a href="https://norocketscience.at/legal/" title="Legal" target="_self">Legal</a></li></ul></nav></header><main class="post"><article class="content"><div class="hero"><header class="hero__content"><div class="wrapper"><h1>Highly separated Talos Kubernetes Cluster: Part 4 - Talos Cluster installationÂ </h1><div class="feed__meta content__meta"><a href="https://norocketscience.at/authors/thomas-brandstetter/" class="feed__author">Thomas Brandstetter</a> <time datetime="2026-03-01T11:07" class="feed__date">March 1, 2026 </time><span class="reading-time" aria-label="10 min read">10 min read</span></div></div></header><figure class="hero__image"><div class="hero__image-wrapper"><img src="https://norocketscience.at/media/posts/10/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-2xl.jpg" srcset="https://norocketscience.at/media/posts/10/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-2xl-xs.jpg 640w, https://norocketscience.at/media/posts/10/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-2xl-sm.jpg 768w, https://norocketscience.at/media/posts/10/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-2xl-md.jpg 1024w, https://norocketscience.at/media/posts/10/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-2xl-lg.jpg 1366w, https://norocketscience.at/media/posts/10/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-2xl-xl.jpg 1600w, https://norocketscience.at/media/posts/10/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-2xl-2xl.jpg 1920w" sizes="88vw" loading="eager" height="1439" width="1920" alt=""></div><figcaption>Photo by Geranimo on Unsplash</figcaption></figure></div><div class="entry-wrapper content__entry"><p>In this part, we install Talos on Proxmox VMs, bootstrap the cluster, enable networking with Calico, and prepare HAProxy Ingress in external mode.</p><h1 id="prerequisites">Prerequisites</h1><p>Before starting, make sure you already read through the other blog posts of this series:</p><ul><li>A reachable and configured Proxmox environment</li><li>The <a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part2-vm-installation/">PFSense server</a> installed and configured</li><li>The <a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part3-pfsense-installation/">Registry server</a> installed and configured</li><li>The <a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part2-vm-installation/">Management client</a> with <code>talosctl</code> and <code>kubectl</code></li><li>The Talos installer image URL from your previous Talos Image Factory installation step</li></ul><h2 id="required-config-patches">Required config patches</h2><p>Before we can install the Talos cluster we need to create patches for the generic installation step. Those changes reflect the on premise registry as well as the lab environment:</p><pre class="line-numbers language-yaml"><code>#lab.yml
machine:
  install:
    disk: /dev/sda
cluster:
  network:
    cni:
      name: none
  discovery:
    enabled: false
---
apiVersion: v1alpha1
kind: ResolverConfig
nameservers:
    - address: 10.10.100.1
searchDomains: # optional
    domains:
        - srv.lab.internal
    disableDefault: false
---
apiVersion: v1alpha1
kind: TimeSyncConfig
ntp:
    servers:
        - 10.10.100.1
---
apiVersion: v1alpha1
kind: TrustedRootsConfig
name: registry-ca
certificates: |
  -----BEGIN CERTIFICATE-----
  "BUT in your ca.rt from the HARBOR installation"
  -----END CERTIFICATE-----</code></pre><pre class="line-numbers language-yaml"><code>#registry_mirror.yml
apiVersion: v1alpha1
kind: RegistryMirrorConfig
name: docker.io
endpoints:
    - url: https://registry.mgmt.lab.internal/v2/proxy-docker.io
      overridePath: true
---
apiVersion: v1alpha1
kind: RegistryMirrorConfig
name: ghcr.io
endpoints:
    - url: https://registry.mgmt.lab.internal/v2/proxy-ghcr.io
      overridePath: true
---
apiVersion: v1alpha1
kind: RegistryMirrorConfig
name: gcr.io
endpoints:
    - url: https://registry.mgmt.lab.internal/v2/proxy-gcr.io
      overridePath: true
---
apiVersion: v1alpha1
kind: RegistryMirrorConfig
name: registry.k8s.io
endpoints:
    - url: https://registry.mgmt.lab.internal/v2/proxy-registry.k8s.io
      overridePath: true
---
apiVersion: v1alpha1
kind: RegistryMirrorConfig
name: quay.io
endpoints:
    - url: https://registry.mgmt.lab.internal/v2/proxy-quay.io
      overridePath: true
</code></pre><h1 id="install-the-talos-cluster">Install the Talos Cluster</h1><h2 id="generate-talos-configs">Generate Talos configs</h2><p>Create the Talos cluster configuration with your custom patches and install image:</p><pre class="line-numbers language-bash"><code>talosctl gen config talos-proxmox-cluster https://10.10.100.10:6443 \
--config-patch @lab.yml \
--config-patch @registry_mirror.yml \
--output-dir _out \
--install-image registry.mgmt.lab.internal:9443/metal-installer-secureboot/ce4c980550dd2ab1b17bbf2b08801c7eb59418eafe8f279833297925d67c7515:v1.12.1</code></pre><p>Next, upload the Talos ISO to Proxmox. The ISO url can be taken from the Talos Image Factory (see last post).&nbsp;Keep the ISO filename consistent with your OpenTofu config references.</p><h2 id="install-the-talos-vms">Install the Talos VMs</h2><p>Now we are ready to provision the last needed VMs via OpenTofu. Ensure both node roles are enabled in your config:</p><pre class="line-numbers language-html"><code>main.tf

Control Plane
resource "proxmox_vm_qemu" "controlplane" {
  name        = "talos-cp-${count.index + 1}"
  target_node = "proxmox2"
  count       = 1
  bios        = "ovmf"
  agent       = 1
  machine     = "q35"
  skip_ipv6   = true

  startup_shutdown {
    order             = 3
    shutdown_timeout  = -1
    startup_delay     = -1
  }

  start_at_node_boot = true
  cpu {
    cores = 4
    sockets = 1
    type = "host"
  }
  memory   = 6144
  scsihw   = "virtio-scsi-pci"
  boot     = "order=scsi0;ide2"

  disks {
    ide {
      ide2 {
        cdrom {
          iso = "local:iso/metal-amd64-secureboot.iso"
        }
      }
    }
    scsi {
      scsi0 {
        disk {
          size     = "64G"
          storage  = "data"
        }
      }
    }
  }

  efidisk {
    efitype = "4m"
    storage = "data"
  }

  network {
    model  = "virtio"
    bridge = "vmbr3"
    firewall = false
    link_down = false
    id = 1
  }

  rng {
    period = 0
    source = "/dev/urandom"
  }

  vga {
    type   = "std"
  }
}

Worker
resource "proxmox_vm_qemu" "worker" {
  name        = "talos-worker-${count.index +1}"
  target_node = "proxmox2"
  count       = 1
  bios        = "ovmf"
  agent       = 1
  machine     = "q35"
  skip_ipv6   = true

  startup_shutdown {
    order             = 4
    shutdown_timeout  = -1
    startup_delay     = -1
  }

  start_at_node_boot = true
  cpu {
    cores = 4
    sockets = 1
    type = "host"
  }
  memory   = 8172
  scsihw   = "virtio-scsi-pci"
  boot     = "order=scsi0;ide2"

  disks {
    ide {
      ide2 {
        cdrom {
          iso = "local:iso/metal-amd64-secureboot.iso"
        }
      }
    }
    scsi {
      scsi0 {
        disk {
          size     = "100G"
          storage  = "data"
        }
      }
    }
  }

  efidisk {
    efitype = "4m"
    storage = "data"
  }

  network {
    model  = "virtio"
    bridge = "vmbr3"
    firewall = false
    link_down = false
    id = 1
  }

  rng {
    period = 0
    source = "/dev/urandom"
  }

  vga {
    type   = "std"
  }
}

</code></pre><p><br>Plan and apply the OpenTofu configuration as we did in the <a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part2-vm-installation/">second blog post</a> of this series.</p><h2 id="provision-the-talos-cluster">Provision the Talos Cluster</h2><p>Initialise the Control Plane:</p><pre class="line-numbers language-bash"><code>talosctl apply-config --insecure --nodes 10.10.100.10 --file _out/controlplane.yaml</code></pre><p>Initialise the Worker node:</p><pre class="line-numbers language-bash"><code>talosctl apply-config --insecure --nodes 10.10.100.11 --file _out/worker.yaml</code></pre><p>Bootstrap the first node:</p><pre class="line-numbers language-bash"><code>export TALOSCONFIG=./talosconfig
talosctl bootstrap -n 10.10.100.10 -e 10.10.100.10</code></pre><p>Create the kube config</p><pre class="line-numbers language-html"><code>talosctl kubeconfig -n 10.10.100.10 -e 10.10.100.10</code></pre><p>Check if your cluster works</p><pre class="line-numbers language-html"><code>kubectl get all --all-namespaces</code></pre><p>If everything is fine and there are not errors in the output, go on to the next step.</p><h1 id="install-calico">Install Calico</h1><p>First of all, install the necessary crd elements:</p><pre class="line-numbers language-bash"><code>kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.31.3/manifests/operator-crds.yaml</code></pre><p>Next install the Calico operator:</p><pre class="line-numbers language-bash"><code>kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.31.3/manifests/tigera-operator.yaml</code></pre><p>Now we need to create the configuration so that Calico is working with PFSense as a BGP Peer:</p><pre class="line-numbers language-yaml"><code># calico-installation.yaml
apiVersion: operator.tigera.io/v1
kind: Installation
metadata:
  name: default
spec:
  calicoNetwork:
    linuxDataplane: BPF
    bpfNetworkBootstrap: Enabled
    kubeProxyManagement: Enabled
    ipPools:
      - name: default-ipv4-pool
        cidr: 10.244.0.0/16
        encapsulation: None
        natOutgoing: Disabled
        nodeSelector: all()
    # Enable BGP
    bgp: Enabled

---
apiVersion: operator.tigera.io/v1
kind: APIServer
metadata:
  name: default
spec: {}</code></pre><pre class="line-numbers language-yaml"><code># felix.yaml
apiVersion: projectcalico.org/v3
kind: FelixConfiguration
metadata:
  name: default
spec:
  cgroupV2Path: "/sys/fs/cgroup"
  bpfEnabled: true
  bpfLogLevel: Info
  prometheusMetricsEnabled: true
</code></pre><pre class="line-numbers language-yaml"><code># bgppeers.yaml
apiVersion: projectcalico.org/v3
kind: BGPPeer
metadata:
  name: pfsense
spec:
  peerIP: 10.10.100.1
  asNumber: 64520
</code></pre><pre class="line-numbers language-yaml"><code># bgpconfig.yaml
apiVersion: projectcalico.org/v3
kind: BGPConfiguration
metadata:
  name: default
spec:
  asNumber: 64512

  # Required when peering with external routers
  nodeToNodeMeshEnabled: false
  logSeverityScreen: Info
</code></pre><p>Install the configuration:</p><pre class="line-numbers language-bash"><code>kubectl apply -f calico-installation.yaml
kubectl apply -f felix.yaml
kubectl apply -f bgppeers.yaml
kubectl apply -f bgpconfig.yaml</code></pre><p>Now wait until Calico provision everything and startup the pods - the output of <code>kubectl get all --all-namespaces</code> should look like this:</p><pre class="line-numbers language-bash"><code>NAMESPACE         NAME                                           READY   STATUS    RESTARTS      AGE
calico-system     pod/calico-apiserver-7c7cf45574-jrq6m          1/1     Running   0             32d
calico-system     pod/calico-apiserver-7c7cf45574-xxjsg          1/1     Running   0             32d
calico-system     pod/calico-kube-controllers-7b8cb555c7-hj8br   1/1     Running   0             32d
calico-system     pod/calico-node-fkgwz                          1/1     Running   0             32d
calico-system     pod/calico-node-nwhnf                          1/1     Running   0             32d
calico-system     pod/calico-typha-657d6fc4fb-4lzsl              1/1     Running   0             32d
calico-system     pod/csi-node-driver-kwcv7                      2/2     Running   0             32d
calico-system     pod/csi-node-driver-qjc8h                      2/2     Running   0             32d
default           pod/app-898dbd577-hztxx                        1/1     Running   0             31d
default           pod/helloworld-v1-699c6788b-ffkj7              1/1     Running   0             31d
kube-system       pod/coredns-7859998f6-6xcrk                    1/1     Running   0             32d
kube-system       pod/coredns-7859998f6-ghbmp                    1/1     Running   0             32d
kube-system       pod/kube-apiserver-talos-cp-1                  1/1     Running   0             32d
kube-system       pod/kube-controller-manager-talos-cp-1         1/1     Running   3 (32d ago)   32d
kube-system       pod/kube-scheduler-talos-cp-1                  1/1     Running   3 (32d ago)   32d
tigera-operator   pod/tigera-operator-6447996989-8j56s           1/1     Running   0             32d

NAMESPACE       NAME                                      TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE
calico-system   service/calico-api                        ClusterIP      10.102.61.204   &lt;none&gt;        443/TCP                  32d
calico-system   service/calico-kube-controllers-metrics   ClusterIP      None            &lt;none&gt;        9094/TCP                 32d
calico-system   service/calico-typha                      ClusterIP      10.105.23.48    &lt;none&gt;        5473/TCP                 32d
default         service/example-service                   ClusterIP      10.108.111.25   &lt;none&gt;        80/TCP                   31d
default         service/helloworld                        LoadBalancer   10.106.229.67   10.50.0.10    5000:31483/TCP           31d
default         service/kubernetes                        ClusterIP      10.96.0.1       &lt;none&gt;        443/TCP                  32d
kube-system     service/kube-dns                          ClusterIP      10.96.0.10      &lt;none&gt;        53/UDP,53/TCP,9153/TCP   32d

NAMESPACE       NAME                             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                                AGE
calico-system   daemonset.apps/calico-node       2         2         2       2            2           kubernetes.io/os=linux                       32d
calico-system   daemonset.apps/csi-node-driver   2         2         2       2            2           kubernetes.io/os=linux                       32d
kube-system     daemonset.apps/kube-proxy        0         0         0       0            0           operator.tigera.io/disable-kube-proxy=true   32d

NAMESPACE         NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE
calico-system     deployment.apps/calico-apiserver          2/2     2            2           32d
calico-system     deployment.apps/calico-kube-controllers   1/1     1            1           32d
calico-system     deployment.apps/calico-typha              1/1     1            1           32d
default           deployment.apps/app                       1/1     1            1           31d
default           deployment.apps/helloworld-v1             1/1     1            1           31d
kube-system       deployment.apps/coredns                   2/2     2            2           32d
tigera-operator   deployment.apps/tigera-operator           1/1     1            1           32d

NAMESPACE         NAME                                                 DESIRED   CURRENT   READY   AGE
calico-system     replicaset.apps/calico-apiserver-7c7cf45574          2         2         2       32d
calico-system     replicaset.apps/calico-kube-controllers-7b8cb555c7   1         1         1       32d
calico-system     replicaset.apps/calico-typha-657d6fc4fb              1         1         1       32d
default           replicaset.apps/app-898dbd577                        1         1         1       31d
default           replicaset.apps/helloworld-v1-699c6788b              1         1         1       31d
kube-system       replicaset.apps/coredns-7859998f6                    2         2         2       32d
tigera-operator   replicaset.apps/tigera-operator-6447996989           1         1         1       32d</code></pre><h2 id="install-the-haproxy-ingress-controller">Install the HAProxy Ingress Controller</h2><p>Now switch to the HAProxy server and go on with the installation of the external HAProxy ingress controller.</p><h2 id="install-haproxy-first">Install HAProxy first</h2><p>Before we can install and use the HAProxy Ingress Controller the HAProxy itself must be installed. For this we need to add the available repository for Ubuntu:</p><pre class="line-numbers language-bash"><code>sudo add-apt-repository ppa:vbernat/haproxy-3.2
sudo apt update
sudo apt install haproxy=3.2.\*
sudo systemctl stop haproxy
sudo systemctl disable haproxy</code></pre><p><strong>Take care</strong> of disabling the HAProxy service, because it can't coexist with the HAProxy ingress controller.</p><h2 id="install-haproxy-ingress-controller">Install HAProxy Ingress Controller</h2><p>The Ingress Controller needs a working Kube config to watch changes from the cluster. It then create or modifies the dynamic haproxy configuration which is the key point of this installation. For the lab, take the kube config from your management client under <code>/ubuntu/.kube</code></p><pre class="line-numbers language-bash"><code>sudo mkdir -p /root/.kube
sudo cp config /root/.kube/config
sudo chown -R root:root /root/.kube</code></pre><p>To use port 80 and port 443 with the controller we need to change the cap configuration:</p><pre class="line-numbers language-bash"><code>sudo setcap cap_net_bind_service=+ep /usr/sbin/haproxy</code></pre><p>Now download the appropriate HAProxy ingress controller version. You see the support matrix on <a href="https://www.haproxy.com/documentation/kubernetes-ingress/community/installation/external-mode-on-premises/">this page</a></p><pre class="line-numbers language-bash"><code>wget https://github.com/haproxytech/kubernetes-ingress/releases/download/v3.2/haproxy-ingress-controller_3.2.6_Linux_x86_64.tar.gz
tar -xzvf haproxy-ingress-controller_3.2.6_Linux_x86_64.tar.gz
sudo cp ./haproxy-ingress-controller /usr/local/bin/</code></pre><p>Create the file <code>/lib/systemd/system/haproxy-ingress.service</code> with the following content:</p><pre class="line-numbers language-bash"><code>[Unit]
Description="HAProxy Kubernetes Ingress Controller"
Documentation=https://www.haproxy.com/
Requires=network-online.target
After=network-online.target

[Service]
Type=simple
User=root
Group=root
ExecStart=/usr/local/bin/haproxy-ingress-controller --external --configmap=default/haproxy-kubernetes-ingress --program=/usr/sbin/haproxy --disable-ipv6 --ipv4-bind-address=0.0.0.0 --http-bind-port=80 --ingress.class=haproxy
ExecReload=/bin/kill --signal HUP $MAINPID
KillMode=process
KillSignal=SIGTERM
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target</code></pre><p>Enable and start the service</p><pre class="line-numbers language-bash"><code>sudo systemctl enable haproxy-ingress
sudo systemctl start haproxy-ingress</code></pre><h2 id="install-bird">Install Bird</h2><p>Bird is the internet routing daemon which gives the HAProxy Ingress controller the routes for the configuration.</p><pre class="line-numbers language-bash"><code>sudo add-apt-repository -y ppa:cz.nic-labs/bird
sudo apt update
sudo apt install bird</code></pre><p>Edit configuration under <code>/etc/bird/bird.conf</code>:</p><pre class="line-numbers language-html"><code>router id 172.16.100.10; 
log syslog all;

# control plane node
protocol bgp {
   local 172.16.100.10 as 64513;
   neighbor 172.16.100.1 as 64520;
   # direct connection
   direct;
   import all;
   export none;
}

# Inserts routes into the kernel routing table
protocol kernel {
   scan time 60;
   export all;
}

# Gets information about network interfaces from the kernel
protocol device {
   scan time 60;
}
</code></pre><p>Enable and start the Bird service:</p><pre class="line-numbers language-html"><code>sudo systemctl enable bird
sudo systemctl restart bird</code></pre><p>Check the status with <code>sudo birdc show protocols</code>:</p><pre class="line-numbers language-bash"><code>BIRD 1.6.8 ready.
name     proto    table    state  since       info
bgp1     BGP      master   up     2026-01-28  Established   
kernel1  Kernel   master   up     2026-01-28  
device1  Device   master   up     2026-01-28  </code></pre><p>The routes from Talos should show up to in the routing table and the dynamic <code>haproxy.conf</code>:</p><pre class="line-numbers language-bash"><code>ip r

default via 172.16.100.1 dev eth0 proto static 
10.244.9.128/26 via 172.16.100.1 dev eth0 proto bird 
10.244.251.0/26 via 172.16.100.1 dev eth0 proto bird 
172.16.100.0/24 dev eth0 proto kernel scope link src 172.16.100.10

grep 10.244 /tmp/haproxy-ingress/etc/haproxy.cfg 

server SRV_1 10.244.251.8:8080 enabled
</code></pre><h2 id="deploy-an-example-app">Deploy an example app</h2><p>Switch to the management client again. Before deploying the demo app, we need to install the custom ingress class for the HAProxy ingress controller:</p><pre class="line-numbers language-yaml"><code># haproxy-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
name: haproxy
spec:
controller: haproxy.org/ingress-controller/haproxy</code></pre><p>Apply it with <code>kubectl apply -f haproxy-ingress.yaml</code></p><p>Create a deployment for the app:</p><pre class="line-numbers language-yaml"><code># demoapp.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    run: app
  name: app
spec:
  replicas: 1
  selector:
    matchLabels:
      run: app
  template:
    metadata:
      labels:
        run: app
    spec:
      containers:
      - name: app
        image: jmalloc/echo-server
        ports:
        - containerPort: 8080
        readinessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
          successThreshold: 1
---
apiVersion: v1
kind: Service
metadata:
    name: example-service
spec:
    selector:
      run: app
    ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 8080

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: example-ingress
  # needed for older HAProxy Ingress versions!
  #annotations:
  #  haproxy.org/ingress.class: "haproxy"
spec:
  ingressClassName: haproxy
  rules:
  - host: "echo.example.com"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: example-service
            port:
              number: 80</code></pre><p>Edit <code>/etc/hosts</code> on the management client:</p><pre class="line-numbers language-html"><code>172.16.100.10    echo.example.com</code></pre><p>Now you can start your browser and call http://echo.example.com</p><figure class="post__image post__image--center"><img loading="lazy" src="https://norocketscience.at/media/posts/10/browser.jpg" height="482" width="1508" alt="" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://norocketscience.at/media/posts/10/responsive/browser-xs.jpg 640w, https://norocketscience.at/media/posts/10/responsive/browser-sm.jpg 768w, https://norocketscience.at/media/posts/10/responsive/browser-md.jpg 1024w, https://norocketscience.at/media/posts/10/responsive/browser-lg.jpg 1366w, https://norocketscience.at/media/posts/10/responsive/browser-xl.jpg 1600w, https://norocketscience.at/media/posts/10/responsive/browser-2xl.jpg 1920w"></figure><h2 id="ready-for-more">Ready for more</h2><p>We have successfully finished the installation of a Talos Cluster on premise with a connected registry which is on premise too. The cluster don't has a direct connection to the internet and the registry is caching needed images. Furthermore the Talos images which are needed to operate the Talos cluster are co signed and the bootstrap Talos image is using or own secure boot keys. In ongoing blog posts I'll show how to update the cluster with updated images and enhance the productivity with an administration ui and observability functionality.</p><h2 id="common-pitfalls-worth-checking-early">Common Pitfalls (Worth checking early)</h2><ul><li>Installer image url typos</li><li>Wrong file path for worker config (`_out/worker.yaml`)</li><li>ISO filename mismatch between Proxmox and OpenTofu config</li><li>Forgetting to create `IngressClass` before applying app Ingress objects</li><li>Applying Calico custom resources before operator/CRDs are ready</li></ul><h2 id="quick-validation-checklist">Quick validation checklist</h2><ul><li><code>talosctl health</code> reports healthy control plane and worker</li><li><code>kubectl get nodes</code> shows all nodes `Ready`</li><li>Calico pods are running in `calico-system` / `tigera-operator` namespaces</li><li>Ingress controller pods/services are healthy</li><li>Example app ingress is admitted and reachable</li></ul><p>That's all for now. Stay tuned and leave me a comment on <a href="https://tinyurl.com/4atbveyr">LinkedIn</a> for any problems or suggestions you have.</p><p>Related posts:</p><ul><li><a href="https://norocketscience.at/supercharged-air-gapped-talos-kubernetes-cluster-an-overview/">Highly separated Talos Kubernetes Cluster: Part 1 - Overview</a></li><li><a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part2-vm-installation/">Highly separated Talos Kubernetes Cluster: Part 2 - VM installation</a></li><li><a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part3-pfsense-installation/">Highly separated Talos Kubernetes Cluster: Part 3 - Registry installation</a></li></ul><p></p></div><footer class="content__footer"><div class="entry-wrapper"><p class="content__updated">This article was updated on March 1, 2026</p><div class="content__actions"><div class="content__share"><button class="btn--icon content__share-button js-content__share-button"><svg width="20" height="20" aria-hidden="true"><use xlink:href="https://norocketscience.at/assets/svg/svg-map.svg#share"></use></svg> <span>Share It</span></button><div class="content__share-popup js-content__share-popup"></div></div></div><div class="content__bio bio"><div><h3 class="h4 bio__name"><a href="https://norocketscience.at/authors/thomas-brandstetter/" rel="author">Thomas Brandstetter</a></h3></div></div></div><nav class="content__nav"><div class="wrapper"><div class="content__nav-inner"><div class="content__nav-prev"><a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part3-pfsense-installation/" class="content__nav-link" rel="prev"><figure class="content__nav-image"><img src="https://norocketscience.at/media/posts/9/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-xs.jpg" class="lazyload" loading="lazy" alt="" height="1439" width="1439"></figure><div><span>Previous</span> Highly separated Talos Kubernetes Cluster: Part 3 - Registry installation</div></a></div></div></div></nav></footer></article><div class="content__related related"><div class="wrapper"><h2 class="h4 related__title">You should also read:</h2><article class="feed__item feed__item--centered"><figure class="feed__image related__image"><img src="https://norocketscience.at/media/posts/9/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl.jpg" srcset="https://norocketscience.at/media/posts/9/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-xs.jpg 640w, https://norocketscience.at/media/posts/9/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-sm.jpg 768w, https://norocketscience.at/media/posts/9/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-md.jpg 1024w" sizes="(min-width: 600px) calc(4.38vw + 143px), 87.86vw" loading="lazy" height="1439" width="1920" alt=""></figure><div class="feed__content"><header><div class="feed__meta"><a href="https://norocketscience.at/authors/thomas-brandstetter/" class="feed__author">Thomas Brandstetter</a> <time datetime="2026-02-25T21:07" class="feed__date">February 25, 2026</time></div><h3 class="feed__title"><a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part3-pfsense-installation/">Highly separated Talos Kubernetes Cluster: Part 3 - Registry installation</a></h3></header><p>Welcome back to another part of building an highly separated Talos Kubernetes cluster! In this part we will install the internal registry which avoids the direct connection to the internet for the Talos cluster. Furthermore, the Talos image factory will be hosted on premise too,&hellip;</p><a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part3-pfsense-installation/" class="readmore feed__readmore">Continue reading...</a></div></article><article class="feed__item feed__item--centered"><figure class="feed__image related__image"><img src="https://norocketscience.at/media/posts/8/geranimo-OomNPPv1Rpk-unsplash-2xl.jpg" srcset="https://norocketscience.at/media/posts/8/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-xs.jpg 640w, https://norocketscience.at/media/posts/8/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-sm.jpg 768w, https://norocketscience.at/media/posts/8/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-md.jpg 1024w" sizes="(min-width: 600px) calc(4.38vw + 143px), 87.86vw" loading="lazy" height="1439" width="1920" alt=""></figure><div class="feed__content"><header><div class="feed__meta"><a href="https://norocketscience.at/authors/thomas-brandstetter/" class="feed__author">Thomas Brandstetter</a> <time datetime="2026-01-30T12:26" class="feed__date">January 30, 2026</time></div><h3 class="feed__title"><a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part2-vm-installation/">Highly separated Talos Kubernetes Cluster: Part 2 - VM installation</a></h3></header><p>Welcome back to our series on building an highly separated Talos Kubernetes cluster! In this second instalment, i'll focus on preparing your Proxmox environment. This involves creating a Proxmox image template for the Ubuntu VMs, downloading necessary images for the management client, and setting up&hellip;</p><a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part2-vm-installation/" class="readmore feed__readmore">Continue reading...</a></div></article><article class="feed__item feed__item--centered"><figure class="feed__image related__image"><img src="https://norocketscience.at/media/posts/7/geranimo-OomNPPv1Rpk-unsplash.jpg" srcset="https://norocketscience.at/media/posts/7/responsive/geranimo-OomNPPv1Rpk-unsplash-xs.jpg 640w, https://norocketscience.at/media/posts/7/responsive/geranimo-OomNPPv1Rpk-unsplash-sm.jpg 768w, https://norocketscience.at/media/posts/7/responsive/geranimo-OomNPPv1Rpk-unsplash-md.jpg 1024w" sizes="(min-width: 600px) calc(4.38vw + 143px), 87.86vw" loading="lazy" height="2992" width="3992" alt=""></figure><div class="feed__content"><header><div class="feed__meta"><a href="https://norocketscience.at/authors/thomas-brandstetter/" class="feed__author">Thomas Brandstetter</a> <time datetime="2026-01-29T20:46" class="feed__date">January 29, 2026</time></div><h3 class="feed__title"><a href="https://norocketscience.at/supercharged-air-gapped-talos-kubernetes-cluster-an-overview/">Highly separated Talos Kubernetes Cluster: Part 1 - Overview</a></h3></header><p>Welcome to the overview of a series on building an Talos Kubernetes cluster with enhanced security. This journey will take you through every step, from setting up the initial infrastructure to deploying a fully functional demo application. In this introductory post, we'll discuss why I'm&hellip;</p><a href="https://norocketscience.at/supercharged-air-gapped-talos-kubernetes-cluster-an-overview/" class="readmore feed__readmore">Continue reading...</a></div></article></div></div></main><footer class="footer footer--glued"><div class="wrapper"><div class="footer__copyright"><p>Powered by Publii</p></div><button id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg width="20" height="20"><use xlink:href="https://norocketscience.at/assets/svg/svg-map.svg#toparrow"/></svg></button></div></footer><script defer="defer" src="https://norocketscience.at/assets/js/scripts.min.js?v=d0fc1030089a37f93a2d51bf6d07565c"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality. <a href="https://norocketscience.at/legal/">More details...</a></div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('ðŸª Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('ðŸª GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('ðŸª Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('ðŸª GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('ðŸª Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && (!cbConfig.initialLsState || cbConfig.initialLsState.indexOf(allowedGroup) === -1)) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('ðŸª GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('ðŸª Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('ðŸª Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('ðŸª Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('ðŸª Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('ðŸª Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('ðŸª Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>
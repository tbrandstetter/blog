<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Highly separated Talos Kubernetes Cluster: Part 3 - Registry installation - No Rocket Science</title><meta name="description" content="Welcome back to another part of building an highly separated Talos Kubernetes cluster! In this part we will install the internal registry which avoids the direct connection to the internet for the Talos cluster. Furthermore, the Talos image factory will be hosted on premise too,&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part3-pfsense-installation/"><link rel="alternate" type="application/atom+xml" href="https://norocketscience.at/feed.xml" title="No Rocket Science - RSS"><link rel="alternate" type="application/json" href="https://norocketscience.at/feed.json" title="No Rocket Science - JSON"><meta property="og:title" content="Highly separated Talos Kubernetes Cluster: Part 3 - Registry installation"><meta property="og:image" content="https://norocketscience.at/media/posts/9/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl.jpg"><meta property="og:image:width" content="1920"><meta property="og:image:height" content="1439"><meta property="og:site_name" content="No Rocket Science"><meta property="og:description" content="Welcome back to another part of building an highly separated Talos Kubernetes cluster! In this part we will install the internal registry which avoids the direct connection to the internet for the Talos cluster. Furthermore, the Talos image factory will be hosted on premise too,&hellip;"><meta property="og:url" content="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part3-pfsense-installation/"><meta property="og:type" content="article"><link rel="stylesheet" href="https://norocketscience.at/assets/css/style.css?v=edb3e68ed34e64f3d75569ba560e8432"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part3-pfsense-installation/"},"headline":"Highly separated Talos Kubernetes Cluster: Part 3 - Registry installation","datePublished":"2026-02-25T21:07+01:00","dateModified":"2026-02-26T08:15+01:00","image":{"@type":"ImageObject","url":"https://norocketscience.at/media/posts/9/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl.jpg","height":1439,"width":1920},"description":"Welcome back to another part of building an highly separated Talos Kubernetes cluster! In this part we will install the internal registry which avoids the direct connection to the internet for the Talos cluster. Furthermore, the Talos image factory will be hosted on premise too,&hellip;","author":{"@type":"Person","name":"Thomas Brandstetter","url":"https://norocketscience.at/authors/thomas-brandstetter/"},"publisher":{"@type":"Organization","name":"Thomas Brandstetter","logo":{"@type":"ImageObject","url":"https://norocketscience.at/media/website/logo_dark.png","height":211,"width":1379}}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body class="post-template"><header class="top js-header"><a class="logo" href="https://norocketscience.at/"><img src="https://norocketscience.at/media/website/logo_dark.png" alt="No Rocket Science" width="1379" height="211"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://norocketscience.at/about-2/" title="About" target="_self">About</a></li><li><a href="https://norocketscience.at/legal/" title="Legal" target="_self">Legal</a></li></ul></nav></header><main class="post"><article class="content"><div class="hero"><header class="hero__content"><div class="wrapper"><h1>Highly separated Talos Kubernetes Cluster: Part 3 - Registry installation</h1><div class="feed__meta content__meta"><a href="https://norocketscience.at/authors/thomas-brandstetter/" class="feed__author">Thomas Brandstetter</a> <time datetime="2026-02-25T21:07" class="feed__date">February 25, 2026 </time><span class="reading-time" aria-label="7 min read">7 min read</span></div></div></header><figure class="hero__image"><div class="hero__image-wrapper"><img src="https://norocketscience.at/media/posts/9/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl.jpg" srcset="https://norocketscience.at/media/posts/9/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-xs.jpg 640w, https://norocketscience.at/media/posts/9/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-sm.jpg 768w, https://norocketscience.at/media/posts/9/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-md.jpg 1024w, https://norocketscience.at/media/posts/9/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-lg.jpg 1366w, https://norocketscience.at/media/posts/9/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-xl.jpg 1600w, https://norocketscience.at/media/posts/9/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-2xl-2xl.jpg 1920w" sizes="88vw" loading="eager" height="1439" width="1920" alt=""></div><figcaption>Photo by Geranimo on Unsplash</figcaption></figure></div><div class="entry-wrapper content__entry"><p>Welcome back to another part of building an highly separated Talos Kubernetes cluster! In this part we will install the internal registry which avoids the direct connection to the internet for the Talos cluster. Furthermore, the Talos image factory will be hosted on premise too, which allows us to create Talos boot images with own secure-boot key locally.</p><p>All installation steps in this post will be taken on the registry host!</p><h2 id="install-docker">Install Docker</h2><p>Harbor is going to be installed as a Docker container. Thus, we need to install Docker first on the Registry host. I'm using the <a href="https://docs.docker.com/engine/install/ubuntu/">official Docker guide</a> for the installation.</p><p>Add the repository:</p><pre class="line-numbers language-bash"><code>sudo apt update
sudo apt install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

sudo tee /etc/apt/sources.list.d/docker.sources &lt;&lt;EOF
Types: deb
URIs: https://download.docker.com/linux/ubuntu
Suites: $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}")
Components: stable
Signed-By: /etc/apt/keyrings/docker.asc
EOF

sudo apt update
</code></pre><p>Install the necessary packages:</p><pre class="line-numbers language-bash"><code>sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</code></pre><p>Verify that Docker is up and running:</p><pre class="line-numbers language-bash"><code>sudo systemctl status docker

# if it isn't running start it
sudo systemctl start docker
</code></pre><p>Add the ubuntu user to the docker group (you have to re-login afterwards):</p><pre class="line-numbers language-bash"><code>sudo usermod -a -G docker ubuntu</code></pre><h2 id="create-self-signed-certificates">Create self-signed certificates</h2><p>To communicate through https between Talos and the registry we're going to use self-signed certificates:</p><pre class="line-numbers language-bash"><code>mkdir $HOME/certs && cd $HOME/certs

# generate the CA private key
openssl genrsa -out ca.key 4096

# generate the CA certificate
openssl req -x509 -new -nodes -sha512 -days 3650 -subj "/C=CN/ST=NA/L=NA/O=homelab/OU=PKI/CN=HOMELAB CA" -key ca.key -out ca.crt

# generate the server certificate private key
openssl genrsa -out registry.mgmt.lab.internal.key 4096

# generate server certificate signing request
openssl req -sha512 -new -subj "/C=CN/ST=NA/L=NA/O=homelab/OU=PKI/CN=registry.mgmt.lab.internal" -key registry.mgmt.lab.internal.key -out registry.mgmt.lab.internal.csr

# generate an x509 v3 extension file
cat &gt; v3.ext &lt;&lt;-EOF
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1=registry.mgmt.lab.internal
DNS.2=registry.mgmt.lab
DNS.3=registry
EOF

# generate the server certificate
openssl x509 -req -sha512 -days 3650 -extfile v3.ext -CA ca.crt -CAkey ca.key -CAcreateserial -in registry.mgmt.lab.internal.csr -out registry.mgmt.lab.internal.crt

# copy certificates and keys to own directory for Harbor installation
sudo mkdir -p /data/cert && sudo cp registry.mgmt.lab.internal.crt registry.mgmt.lab.internal.key /data/cert/
</code></pre><h2 id="installing-harbor-registry">Installing Harbor registry</h2><p>Download and extract the latest Harbor offline installer from&nbsp;<a href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a></p><pre class="line-numbers language-bash"><code>wget https://github.com/goharbor/harbor/releases/download/v2.14.2/harbor-offline-installer-v2.14.2.tgz
tar xzvf harbor-offline-installer-v2.14.2.tgz
</code></pre><p>Next we have to configure Harbor through the harbor.yml file:</p><pre class="line-numbers language-yaml"><code>hostname: registry.mgmt.lab.internal
https:
  port: 443
  certificate: /data/cert/registry.mgmt.lab.internal.crt
  private_key: /data/cert/registry.mgmt.lab.internal.key

harbor_admin_password: Harbor12345

database:
  password: root123
  max_idle_conns: 100
  max_open_conns: 900
  conn_max_lifetime: 5m
  conn_max_idle_time: 0

data_volume: /data

jobservice:
  max_job_workers: 10
  max_job_duration_hours: 24
  job_loggers:
    - STD_OUTPUT
    - FILE
  logger_sweeper_duration: 1 #days

notification:
  webhook_job_max_retry: 3
  webhook_job_http_client_timeout: 3 #seconds

log:
  level: info
  local:
    rotate_count: 50
    rotate_size: 200M
    location: /var/log/harbor

#This attribute is for migrator to detect the version of the .cfg file, DO NOT MODIFY!
_version: 2.14.0

upload_purging:
  age: 168h
  interval: 24h
  dryrun: false

cache:
  enabled: false
  expire_hours: 24</code></pre><p>Finally, we can install the Harbor registry using the offline installer:</p><pre class="line-numbers language-bash"><code>cd harbor && sudo ./install.sh
</code></pre><p>If everything went fine you should see the docker container running with docker ps:</p><figure class="post__image post__image--center"><img loading="lazy" src="https://norocketscience.at/media/posts/9/harbor1.jpg" height="264" width="2734" alt="" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://norocketscience.at/media/posts/9/responsive/harbor1-xs.jpg 640w, https://norocketscience.at/media/posts/9/responsive/harbor1-sm.jpg 768w, https://norocketscience.at/media/posts/9/responsive/harbor1-md.jpg 1024w, https://norocketscience.at/media/posts/9/responsive/harbor1-lg.jpg 1366w, https://norocketscience.at/media/posts/9/responsive/harbor1-xl.jpg 1600w, https://norocketscience.at/media/posts/9/responsive/harbor1-2xl.jpg 1920w"></figure><p>Go to https://registry.mgt.lab.internal and you should see the administration interface:</p><figure class="post__image post__image--center"><img loading="lazy" src="https://norocketscience.at/media/posts/9/harbor2.jpg" height="1316" width="2574" alt="" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://norocketscience.at/media/posts/9/responsive/harbor2-xs.jpg 640w, https://norocketscience.at/media/posts/9/responsive/harbor2-sm.jpg 768w, https://norocketscience.at/media/posts/9/responsive/harbor2-md.jpg 1024w, https://norocketscience.at/media/posts/9/responsive/harbor2-lg.jpg 1366w, https://norocketscience.at/media/posts/9/responsive/harbor2-xl.jpg 1600w, https://norocketscience.at/media/posts/9/responsive/harbor2-2xl.jpg 1920w"></figure><p>The password is the same as from the harbor.yaml</p><p>Be aware that on a reboot you have to manually start the service with docker compose in the harbor directory. If you like to autostart the service, install the systemd service file from&nbsp;<a href="https://github.com/goharbor/harbor/blob/main/tools/systemd/harbor.service">https://github.com/goharbor/harbor/blob/main/tools/systemd/harbor.service</a>&nbsp;and copy the docker compose file to /etc/goharbor/harbor/docker-compose.yml</p><h2 id="configure-proxy-caches">Configure proxy caches</h2><p>With the running Harbor registry we can create the needed proxy caches for Talos. The following registries have to be configured:</p><p>Provider: Docker Hub<br>Name: docker.io<br>Endpoint Url: https://hub.docker.com<br>Access ID: leave empty<br>Access Secret: leave empty<br>Verify Remote Cert: Checked<br><br>Provider: Docker Registry<br>Name: gcr.io<br>Endpoint Url: https://gcr.io<br>Access ID: leave empty<br>Access Secret: leave empty<br>Verify Remote Cert: Checked<br><br>Provider: Docker Registry<br>Name: quay.io<br>Endpoint Url: https://quay.io<br>Access ID: leave empty<br>Access Secret: leave empty<br>Verify Remote Cert: Checked<br><br>Provider: Docker Registry<br>Name: registry.k8s.io<br>Endpoint Url: https://registry.k8s.io<br>Access ID: leave empty<br>Access Secret: leave empty<br>Verify Remote Cert: Checked<br><br>Provider: Github GHCR<br>Name: ghcr.io<br>Endpoint Url: https://ghcr.io<br>Access ID: leave empty<br>Access Secret: leave empty<br>Verify Remote Cert: Checked<br><br>In the gui it looks like this:</p><figure class="post__image post__image--center"><img loading="lazy" src="https://norocketscience.at/media/posts/9/harbor3.jpg" height="1020" width="1134" alt="" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://norocketscience.at/media/posts/9/responsive/harbor3-xs.jpg 640w, https://norocketscience.at/media/posts/9/responsive/harbor3-sm.jpg 768w, https://norocketscience.at/media/posts/9/responsive/harbor3-md.jpg 1024w, https://norocketscience.at/media/posts/9/responsive/harbor3-lg.jpg 1366w, https://norocketscience.at/media/posts/9/responsive/harbor3-xl.jpg 1600w, https://norocketscience.at/media/posts/9/responsive/harbor3-2xl.jpg 1920w"></figure><p>Afterwards we're mapping the repositories as proxy cache. Go to the projects tab and click on "New project". Fill out the name with prefix "proxy-". Set the Access Level to public to avoid authentication from the Talos nodes and select the right repository in Proxy Cache. Repeat this step for all available repositories you created.</p><figure class="post__image post__image--center"><img loading="lazy" src="https://norocketscience.at/media/posts/9/habor.jpg" height="968" width="1080" alt="" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://norocketscience.at/media/posts/9/responsive/habor-xs.jpg 640w, https://norocketscience.at/media/posts/9/responsive/habor-sm.jpg 768w, https://norocketscience.at/media/posts/9/responsive/habor-md.jpg 1024w, https://norocketscience.at/media/posts/9/responsive/habor-lg.jpg 1366w, https://norocketscience.at/media/posts/9/responsive/habor-xl.jpg 1600w, https://norocketscience.at/media/posts/9/responsive/habor-2xl.jpg 1920w"></figure><p>Additionally, we need a "siderolabs" project for the Talos Image factory. This is setup as a plain project without a Proxy Cache. Still Public as the other ones. Finally, the projects should look like this:</p><figure class="post__image post__image--center"><img loading="lazy" src="https://norocketscience.at/media/posts/9/harbor2-3.jpg" height="426" width="1330" alt="" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://norocketscience.at/media/posts/9/responsive/harbor2-3-xs.jpg 640w, https://norocketscience.at/media/posts/9/responsive/harbor2-3-sm.jpg 768w, https://norocketscience.at/media/posts/9/responsive/harbor2-3-md.jpg 1024w, https://norocketscience.at/media/posts/9/responsive/harbor2-3-lg.jpg 1366w, https://norocketscience.at/media/posts/9/responsive/harbor2-3-xl.jpg 1600w, https://norocketscience.at/media/posts/9/responsive/harbor2-3-2xl.jpg 1920w"></figure><h2 id="installing-talos-image-factory">Installing Talos Image Factory</h2><p>The image factory is needed to create an boot image locally with your own secure boot keys. Talos has a own dedicated service for this too, but for this blog series we're going fully on premise for the bootstrap images.</p><p></p><h3 id="prerequisites">Prerequisites</h3><ul><li><a href="https://github.com/google/go-containerregistry/blob/main/cmd/crane/README.md">Crane</a></li><li>Signing Key for co signing:&nbsp;<code>openssl ecparam -name prime256v1 -genkey -noout -out signing-key.key</code></li><li><a href="https://www.talos.dev">Talosctl</a> on the Management Client</li></ul><p>Get the Talos image list and copy the txt file from the management to the registry host:</p><pre class="line-numbers language-bash"><code>talosctl image talos-bundle v1.12.1 &gt; images.txt</code></pre><p>Copy the necessary images from siderolabs to internal registry with the following script:</p><pre class="line-numbers language-bash"><code>REGISTRY_ENDPOINT=registry.mgmt.lab.internal
crane auth login ${REGISTRY_ENDPOINT} -u admin -p Harbor12345
for SOURCE_IMAGE in $(cat images.txt)
  do
    IMAGE_WITHOUT_DIGEST=${SOURCE_IMAGE%%@*}
    IMAGE_WITH_NEW_REG="${REGISTRY_ENDPOINT}/${IMAGE_WITHOUT_DIGEST#*/}"
    crane --insecure copy \
      $SOURCE_IMAGE \
      $IMAGE_WITH_NEW_REG
done</code></pre><p>Create cosign key with:</p><pre class="line-numbers language-bash"><code>sudo docker run --rm -it \
-v $PWD:/keys -w /keys \
-e COSIGN_PASSWORD="" \
--user $(id -u):$(id -g) \
ghcr.io/sigstore/cosign/cosign:v2.6.1 \
generate-key-pair</code></pre><p>Sign Images:</p><pre class="line-numbers language-bash"><code>KEY_FILE="cosign.key"
REGISTRY_ENDPOINT=registry.mgmt.lab.internal
crane auth login ${REGISTRY_ENDPOINT} -u admin -p Harbor12345

for IMAGE in $(cat images.txt)
  do
    NEW_IMAGE="${REGISTRY_ENDPOINT}/${IMAGE#*/}"
    if [[ "$NEW_IMAGE" != *"@sha256:"* ]]; then
      NEW_IMAGE="${NEW_IMAGE}@$(crane --insecure digest $NEW_IMAGE)"
    fi
    docker run --rm -it --net=host \
      -v $PWD:/keys -w /keys \
      -v $HOME/.docker/config.json:/.docker/config.json:ro \
      -e DOCKER_CONFIG=/.docker \
      -e COSIGN_PASSWORD="" \
      -e COSIGN_YES=true \
      --user $(id -u):$(id -g) \
      docker.io/bitnami/cosign:latest \
        sign \
	--allow-insecure-registry \
	--key /keys/$KEY_FILE \
        --tlog-upload=false \
	--use-signing-config=false \
	--new-bundle-format=false \
        $NEW_IMAGE
done
</code></pre><p>Generate SecureBoot keys/certs with:</p><pre class="line-numbers language-bash"><code>talosctl gen secureboot pcr (PCR Key)
talosctl gen secureboot uki --common-name "SecureBoot Key" (Signing Key and Cert)
</code></pre><p><br>copy the&nbsp;<code>pcr-signing-key.pem</code>,&nbsp;<code>uki-signing-key.pem</code> and&nbsp;<code>uki-signing-cert.pem</code> to the registry host</p><p>Create the configuration for the Talos image factory with a env.yml file:</p><pre class="line-numbers language-yaml"><code>#env.yml
artifacts:
    core:
        components:
            extensionManifest: siderolabs/extensions
            imager: siderolabs/imager
            installer: siderolabs/installer
            installerBase: siderolabs/installer-base
            overlayManifest: siderolabs/overlays
            talosctl: siderolabs/talosctl-all
        insecure: false
        registry: registry.mgmt.lab.internal
    installer:
        external:
            insecure: false
            namespace: ""
            registry: ""
            repository: ""
        internal:
            insecure: false
            namespace: siderolabs
            registry: registry.mgmt.lab.internal
            repository: ""
    refreshInterval: 5m0s
    schematic:
        insecure: false
        namespace: siderolabs/image-factory
        registry: registry.mgmt.lab.internal
        repository: schematics
    talosVersionRecheckInterval: 15m0s
build:
    maxConcurrency: 6
    minTalosVersion: 1.2.0
cache:
    cdn:
        enabled: false
        host: ""
        trimPrefix: ""
    oci:
        insecure: false
        namespace: siderolabs/image-factory
        registry: registry.mgmt.lab.internal
        repository: cache
    s3:
        bucket: image-factory
        enabled: false
        endpoint: ""
        insecure: false
        region: ""
    signingKeyPath: "/signing-key.key"
containerSignature:
    disabled: false
    issuer: https://accounts.google.com
    issuerRegExp: ""
    publicKeyFile: "/cosign.pub"
    publicKeyHashAlgo: sha256
    subjectRegExp: '@siderolabs\.com$'
http:
    allowedOrigins:
        - '*'
    certFile: "/certs/server-chain.pem"
    externalPXEURL: ""
    externalURL: https://registry.mgmt.lab.internal:9443/
    httpListenAddr: :8080
    keyFile: "/certs/server-key.pem"
metrics:
    addr: :2122
secureBoot:
    awsKMS:
        certARN: ""
        certPath: ""
        keyID: ""
        pcrKeyID: ""
        region: ""
    azureKeyVault:
        certificateName: ""
        keyName: ""
        url: ""
    enabled: true
    file:
        pcrKeyPath: "./pcr-signing-key.pem"
        signingCertPath: "./uki-signing-cert.pem"
        signingKeyPath: "./uki-signing-key.pem"</code></pre><p>Start Talos Image Factory with docker-compose:</p><pre class="line-numbers language-yaml"><code>services:
  image-factory:
    image: "ghcr.io/siderolabs/image-factory:v1.0.0-beta.0"
    restart: unless-stopped
    container_name: image-factory
    ports:
      - "9443:8080"
    volumes:
      - $HOME/.docker/config.json:/.docker/config.json
      - ./env.yaml:/env.yaml
      - ./pcr-signing-key.pem:/pcr-signing-key.pem
      - ./uki-signing-key.pem:/uki-signing-key.pem
      - ./uki-signing-cert.pem:/uki-signing-cert.pem
      - ./signing-key.key:/signing-key.key
      - ./cosign.pub:/cosign.pub
      # CA cert for Habor verification
      - ./ca.crt:/etc/pki/tls/cacert.pem
      - /data/cert/registry.mgmt.lab.internal.key:/certs/server-key.pem
      - /data/cert/registry.mgmt.lab.internal.crt:/certs/server-chain.pem
    command: 
      --config env.yaml</code></pre><h2 id="generate-the-bootstrap-image">Generate the bootstrap image</h2><p>Go to <a href="https://registry.mgmt.lab.internal:9443">https://registry.mgmt.lab.internal:9443</a> and set the following options:</p><figure class="post__image post__image--center"><img loading="lazy" src="https://norocketscience.at/media/posts/9/talosif.jpg" height="764" width="1112" alt="" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://norocketscience.at/media/posts/9/responsive/talosif-xs.jpg 640w, https://norocketscience.at/media/posts/9/responsive/talosif-sm.jpg 768w, https://norocketscience.at/media/posts/9/responsive/talosif-md.jpg 1024w, https://norocketscience.at/media/posts/9/responsive/talosif-lg.jpg 1366w, https://norocketscience.at/media/posts/9/responsive/talosif-xl.jpg 1600w, https://norocketscience.at/media/posts/9/responsive/talosif-2xl.jpg 1920w"></figure><figure class="post__image post__image--center"><img loading="lazy" src="https://norocketscience.at/media/posts/9/talosif2.jpg" height="811" width="1417" alt="" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://norocketscience.at/media/posts/9/responsive/talosif2-xs.jpg 640w, https://norocketscience.at/media/posts/9/responsive/talosif2-sm.jpg 768w, https://norocketscience.at/media/posts/9/responsive/talosif2-md.jpg 1024w, https://norocketscience.at/media/posts/9/responsive/talosif2-lg.jpg 1366w, https://norocketscience.at/media/posts/9/responsive/talosif2-xl.jpg 1600w, https://norocketscience.at/media/posts/9/responsive/talosif2-2xl.jpg 1920w"></figure><figure class="post__image post__image--center"><img loading="lazy" src="https://norocketscience.at/media/posts/9/talosif3.jpg" height="811" width="1417" alt="" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://norocketscience.at/media/posts/9/responsive/talosif3-xs.jpg 640w, https://norocketscience.at/media/posts/9/responsive/talosif3-sm.jpg 768w, https://norocketscience.at/media/posts/9/responsive/talosif3-md.jpg 1024w, https://norocketscience.at/media/posts/9/responsive/talosif3-lg.jpg 1366w, https://norocketscience.at/media/posts/9/responsive/talosif3-xl.jpg 1600w, https://norocketscience.at/media/posts/9/responsive/talosif3-2xl.jpg 1920w"></figure><p id="summary">Upload the image as proxmox iso image. We're going to use that to bootstrap the Talos cluster in the next session</p><figure class="post__image post__image--center"><img loading="lazy" src="https://norocketscience.at/media/posts/9/talosif4.jpg" height="229" width="1813" alt="" sizes="(max-width: 1920px) 100vw, 1920px" srcset="https://norocketscience.at/media/posts/9/responsive/talosif4-xs.jpg 640w, https://norocketscience.at/media/posts/9/responsive/talosif4-sm.jpg 768w, https://norocketscience.at/media/posts/9/responsive/talosif4-md.jpg 1024w, https://norocketscience.at/media/posts/9/responsive/talosif4-lg.jpg 1366w, https://norocketscience.at/media/posts/9/responsive/talosif4-xl.jpg 1600w, https://norocketscience.at/media/posts/9/responsive/talosif4-2xl.jpg 1920w"></figure><h2 id="summary">Summary</h2><p>We now have a running registry using Harbor and a Talos Image Factory on premise to create local Talos bootstrap images with a own secure boot key. In the next post we will configure and install the Talos cluster.</p><p>That's all for now. Stay tuned and leave me a comment on <a href="https://tinyurl.com/4atbveyr">LinkedIn</a> for any problems or suggestions you have.</p><p>Related posts:</p><ul><li><a href="https://norocketscience.at/supercharged-air-gapped-talos-kubernetes-cluster-an-overview/" style="font-size: 1em;">Highly separated Talos Kubernetes Cluster: Part1 - Overview</a></li><li><a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part2-vm-installation/" style="font-size: 1em;">Highly separated Talos Kubernetes Cluster: Part 2 - VM installation</a></li></ul><p></p></div><footer class="content__footer"><div class="entry-wrapper"><p class="content__updated">This article was updated on February 26, 2026</p><div class="content__actions"><div class="content__share"><button class="btn--icon content__share-button js-content__share-button"><svg width="20" height="20" aria-hidden="true"><use xlink:href="https://norocketscience.at/assets/svg/svg-map.svg#share"></use></svg> <span>Share It</span></button><div class="content__share-popup js-content__share-popup"></div></div></div><div class="content__bio bio"><div><h3 class="h4 bio__name"><a href="https://norocketscience.at/authors/thomas-brandstetter/" rel="author">Thomas Brandstetter</a></h3></div></div></div><nav class="content__nav"><div class="wrapper"><div class="content__nav-inner"><div class="content__nav-prev"><a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part2-vm-installation/" class="content__nav-link" rel="prev"><figure class="content__nav-image"><img src="https://norocketscience.at/media/posts/8/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-xs.jpg" class="lazyload" loading="lazy" alt="" height="1439" width="1439"></figure><div><span>Previous</span> Highly separated Talos Kubernetes Cluster: Part 2 - VM installation</div></a></div></div></div></nav></footer></article><div class="content__related related"><div class="wrapper"><h2 class="h4 related__title">You should also read:</h2><article class="feed__item feed__item--centered"><figure class="feed__image related__image"><img src="https://norocketscience.at/media/posts/8/geranimo-OomNPPv1Rpk-unsplash-2xl.jpg" srcset="https://norocketscience.at/media/posts/8/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-xs.jpg 640w, https://norocketscience.at/media/posts/8/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-sm.jpg 768w, https://norocketscience.at/media/posts/8/responsive/geranimo-OomNPPv1Rpk-unsplash-2xl-md.jpg 1024w" sizes="(min-width: 600px) calc(4.38vw + 143px), 87.86vw" loading="lazy" height="1439" width="1920" alt=""></figure><div class="feed__content"><header><div class="feed__meta"><a href="https://norocketscience.at/authors/thomas-brandstetter/" class="feed__author">Thomas Brandstetter</a> <time datetime="2026-01-30T12:26" class="feed__date">January 30, 2026</time></div><h3 class="feed__title"><a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part2-vm-installation/">Highly separated Talos Kubernetes Cluster: Part 2 - VM installation</a></h3></header><p>Welcome back to our series on building an highly separated Talos Kubernetes cluster! In this second instalment, i'll focus on preparing your Proxmox environment. This involves creating a Proxmox image template for the Ubuntu VMs, downloading necessary images for the management client, and setting up&hellip;</p><a href="https://norocketscience.at/highly-separated-talos-kubernetes-cluster-part2-vm-installation/" class="readmore feed__readmore">Continue reading...</a></div></article><article class="feed__item feed__item--centered"><figure class="feed__image related__image"><img src="https://norocketscience.at/media/posts/7/geranimo-OomNPPv1Rpk-unsplash.jpg" srcset="https://norocketscience.at/media/posts/7/responsive/geranimo-OomNPPv1Rpk-unsplash-xs.jpg 640w, https://norocketscience.at/media/posts/7/responsive/geranimo-OomNPPv1Rpk-unsplash-sm.jpg 768w, https://norocketscience.at/media/posts/7/responsive/geranimo-OomNPPv1Rpk-unsplash-md.jpg 1024w" sizes="(min-width: 600px) calc(4.38vw + 143px), 87.86vw" loading="lazy" height="2992" width="3992" alt=""></figure><div class="feed__content"><header><div class="feed__meta"><a href="https://norocketscience.at/authors/thomas-brandstetter/" class="feed__author">Thomas Brandstetter</a> <time datetime="2026-01-29T20:46" class="feed__date">January 29, 2026</time></div><h3 class="feed__title"><a href="https://norocketscience.at/supercharged-air-gapped-talos-kubernetes-cluster-an-overview/">Highly separated Talos Kubernetes Cluster: Part 1 - Overview</a></h3></header><p>Welcome to the overview of a series on building an Talos Kubernetes cluster with enhanced security. This journey will take you through every step, from setting up the initial infrastructure to deploying a fully functional demo application. In this introductory post, we'll discuss why I'm&hellip;</p><a href="https://norocketscience.at/supercharged-air-gapped-talos-kubernetes-cluster-an-overview/" class="readmore feed__readmore">Continue reading...</a></div></article></div></div></main><footer class="footer footer--glued"><div class="wrapper"><div class="footer__copyright"><p>Powered by Publii</p></div><button id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg width="20" height="20"><use xlink:href="https://norocketscience.at/assets/svg/svg-map.svg#toparrow"/></svg></button></div></footer><script defer="defer" src="https://norocketscience.at/assets/js/scripts.min.js?v=d0fc1030089a37f93a2d51bf6d07565c"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality. <a href="https://norocketscience.at/legal/">More details...</a></div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('üç™ Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('üç™ GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('üç™ Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('üç™ GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('üç™ Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && (!cbConfig.initialLsState || cbConfig.initialLsState.indexOf(allowedGroup) === -1)) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('üç™ GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('üç™ Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('üç™ Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('üç™ State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('üç™ Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('üç™ Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('üç™ Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('üç™ Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('üç™ Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('üç™ Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('üç™ Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>
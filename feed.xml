<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xmlns:media="http://search.yahoo.com/mrss/">
    <title>No Rocket Science</title>
    <link href="https://norocketscience.at/feed.xml" rel="self" />
    <link href="https://norocketscience.at" />
    <updated>2026-01-29T08:59:28+01:00</updated>
    <author>
        <name>Thomas Brandstetter</name>
    </author>
    <id>https://norocketscience.at</id>

    <entry>
        <title>Deploy Proxmox virtual machines using Cloud-init</title>
        <author>
            <name>Thomas Brandstetter</name>
        </author>
        <link href="https://norocketscience.at/about/"/>
        <id>https://norocketscience.at/about/</id>
        <media:content url="https://norocketscience.at/media/posts/1/photo-1526666923127-b2970f64b422.webp" medium="image" />

        <updated>2019-12-02T08:57:00+01:00</updated>
            <summary type="html">
                <![CDATA[
                        <img src="https://norocketscience.at/media/posts/1/photo-1526666923127-b2970f64b422.webp" alt="" />
                    Due to performance problems with my ESXI homelab I decided to give the open source solution Proxmox a try. One of my goals was to install all my virtual machines with the Cloud-init solution. With Cloud-init it is possible to inject informations such as ssh&hellip;
                ]]>
            </summary>
        <content type="html">
            <![CDATA[
                    <p><img src="https://norocketscience.at/media/posts/1/photo-1526666923127-b2970f64b422.webp" class="type:primaryImage" alt="" /></p>
                
  <p>
    Due to performance problems with my ESXI homelab I decided to give the open source solution Proxmox a try. One of my goals was to install all my virtual machines with the Cloud-init solution. With Cloud-init it is possible to inject informations such as ssh keys, network information or user profiles in an standarized way at boot time. The benefit of using Cloud-init is the pre-provisioning of necessary configuration items such as a static ip address or a default user with activated ssh public key authentication. Furthermore, this kind of provisioning helps a lot for further automation steps with Ansible or even complete CI/CD pipelines in Gitlab, Jenkins etc. But first, let's start with the VM provisioning steps in Proxmox.
  </p>

    <h2 id="location-of-cloud-init-images">
      Location of Cloud-Init images
    </h2>

  <p>
    Nowadays, nearly all big Linux distributions offer ready to use Cloud-init images. Here is a short list of mirrors where you can choose the distribution that fits your needs:
  </p>

  <ul>
    <li>Ubuntu: <a href="https://cloud-images.ubuntu.com">https://cloud-images.ubuntu.com</a></li><li>Debian: <a href="https://cloud.debian.org/images/cloud/">https://cloud.debian.org/images/cloud/</a></li><li>CentOs: <a href="https://cloud.centos.org/centos/7/images/">https://cloud.centos.org/centos/7/images/</a></li>
  </ul>

    <h2 id="create-your-template">
      Create your template
    </h2>

  <p>
    All commands below have to be executed on the Proxmox server. You can ssh into it or use the shell in the web interface.
  </p>

    <h3 id="download-the-image-on-your-proxmox-server">
      Download the image on your Proxmox server
    </h3>

  <p>
    I'm using Ubuntu for my VMs
  </p>
<pre class="line-numbers  language-bash"><code>bash 
wget https://cloud-images.ubuntu.com/daily/server/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img
</code></pre>

    <h3 id="define-your-virtual-machine-as-templatelessbrgreater">
      Define your virtual machine as template<br>
    </h3>
<pre class="line-numbers  language-bash"><code>bash
qm create 9000 --name "ubuntu-2404-cloudinit-template" --memory 2048 --net0 virtio,bridge=vmbr0
</code></pre>

  <p>
    With this command you have created a new virtual machine with the id 9000 (has to be unique in the Proxmox ecosystem), 2 gigabyte of ram and a bridge network using the virtio controller. I took vmbr0 because it is the standard bridge in Proxmox. Feel free to use another one or add additional hardware to your template.
  </p>

    <h3 id="import-the-disk-image-in-the-local-proxmox-storage">
      Import the disk image in the local Proxmox storage
    </h3>
<pre class="line-numbers  language-bash"><code>bash
qm importdisk 9000 ubuntu-24.04-server-cloudimg-amd64.img local-lvm
</code></pre>

  <p>
    The command line utility copies the image in the local Proxmox storage and assigns it to the previously created template VM with the id 9000. Because it is the first disk for the vm, Proxmox is creating a disk with the naming "vm-9000-disk-0".
  </p>

    <h3 id="configure-your-virtual-machine-to-use-the-disk-image">
      Configure your virtual machine to use the disk image
    </h3>
<pre class="line-numbers  language-bash"><code>bash
qm set 9000 --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-9000-disk-0
</code></pre>

    <h3 id="adding-the-cloud-init-image-as-cd-rom-to-your-virtual-machine">
      Adding the Cloud-init image as CD-Rom to your virtual machine
    </h3>
<pre class="line-numbers  language-bash"><code>qm set 9000 --ide2 local-lvm:cloudinit
</code></pre>

  <p>
    This is an important step, because it allows you to change the settings I've already mentioned before. Do not set anything else here, because we're using this virtual machine as a template. You can edit the settings after you've cloned the template for use.<br>
  </p>

    <h3 id="restrict-the-virtual-machine-to-boot-from-the-cloud-init-image-only">
      Restrict the virtual machine to boot from the Cloud-init image only
    </h3>
<pre class="line-numbers  language-bash"><code>bash
qm set 9000 --boot c --bootdisk scsi0</code></pre>

    <h3 id="attach-a-serial-console-to-the-virtual-machine-this-is-needed-for-some-cloud-init-distributions-such-as-ubuntu">
      Attach a serial console to the virtual machine (this is needed for some Cloud-Init distributions, such as Ubuntu)
    </h3>
<pre class="line-numbers  language-bash"><code>bash
qm set 9000 --serial0 socket --vga serial0</code></pre>

    <h3 id="finally-create-a-template">
      Finally create a template
    </h3>
<pre class="line-numbers  language-bash"><code>bash
qm template 9000</code></pre>

    <h2 id="create-a-virtual-machine-out-of-the-template">
      Create a virtual machine out of the template
    </h2>

  <p>
    With the template you can clone as many virtual machines as you like and change the Cloud-init parameters for your needs. First we have to clone the template to a new virtual machine:
  </p>
<pre class="line-numbers  language-bash"><code>bash
qm clone 9000 100 --name my-virtual-machine</code></pre>

  <p>
    We created a new virtual machine with the unique id 100 and the name "my-virtual-machine". Now you can change the Cloud-init settings either in the admin ui or with the qm command:
  </p>
<pre class="line-numbers  language-bash"><code>bash
qm set 100 --sshkey ~/.ssh/id_rsa.pub 
qm set 123 --ipconfig0 ip=192.168.2.100/24,gw=192.168.2.1</code></pre>

  <p>
    With this command you have set a public key for SSH authentication and the static IP 192.168.2.100. We didn't set a user which means Ubuntu is using the default one (ubuntu). That's it! Your Cloud-Init image should now boot up fine with the desired settings.
  </p>

    <h2 id="next-steps">
      Next steps
    </h2>

  <p>
    This tutorial is just the beginning. You're now able to use Terraform, Ansible or other automation tools to create "Infrastructure as a code" helping you to ramp up whole datacenters with just a few commands.
  </p>

  <p>
    But this is another story I have to tell ;-)
  </p>

  <p>
    Source: <a href="https://pve.proxmox.com/wiki/Cloud-Init_Support">https://pve.proxmox.com/wiki/Cloud-Init_Support</a>
  </p>
            ]]>
        </content>
    </entry>
</feed>
